<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Th·ªëng K√™ Chi Ti·∫øt - Qu·∫£n L√Ω Chi Ti√™u</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    .chart-container {
      position: relative;
      height: 400px;
      margin: 20px 0;
    }
    .stats-card {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }
  </style>
</head>
<body class="bg-gray-100">
  <div class="container mx-auto max-w-6xl p-6">
    <!-- Header -->
    <header class="bg-purple-600 text-white p-6 rounded-lg mb-6">
      <div class="flex justify-between items-center">
        <div>
          <h1 class="text-3xl font-bold">üìä Th·ªëng K√™ Chi Ti√™u Chi Ti·∫øt</h1>
          <p class="text-purple-200 mt-2">Ph√¢n t√≠ch chi ti√™u c·ªßa b·∫°n m·ªôt c√°ch chi ti·∫øt</p>
        </div>
        <button onclick="window.close()" class="bg-purple-500 hover:bg-purple-400 px-4 py-2 rounded">
          ‚Üê Quay l·∫°i
        </button>
      </div>
    </header>

    <!-- T·ªïng quan nhanh -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
      <div class="stats-card p-6 rounded-lg text-center">
        <h3 class="text-lg font-semibold">T·ªïng Chi Ti√™u</h3>
        <p class="text-3xl font-bold mt-2" id="totalAmount">0k</p>
      </div>
      <div class="bg-green-500 text-white p-6 rounded-lg text-center">
        <h3 class="text-lg font-semibold">S·ªë Giao D·ªãch</h3>
        <p class="text-3xl font-bold mt-2" id="totalTransactions">0</p>
      </div>
      <div class="bg-blue-500 text-white p-6 rounded-lg text-center">
        <h3 class="text-lg font-semibold">Chi Ti√™u TB/Ng√†y</h3>
        <p class="text-3xl font-bold mt-2" id="avgPerDay">0k</p>
      </div>
      <div class="bg-red-500 text-white p-6 rounded-lg text-center">
        <h3 class="text-lg font-semibold">Lo·∫°i Chi Nhi·ªÅu Nh·∫•t</h3>
        <p class="text-lg font-bold mt-2" id="topCategory">-</p>
      </div>
    </div>

    <!-- Bi·ªÉu ƒë·ªì -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
      <!-- Bi·ªÉu ƒë·ªì tr√≤n -->
      <div class="bg-white p-6 rounded-lg shadow-md">
        <h2 class="text-xl font-semibold mb-4">Ph√¢n B·ªë Theo Lo·∫°i</h2>
        <div class="chart-container">
          <canvas id="pieChart"></canvas>
        </div>
      </div>

      <!-- Bi·ªÉu ƒë·ªì c·ªôt -->
      <div class="bg-white p-6 rounded-lg shadow-md">
        <h2 class="text-xl font-semibold mb-4">Chi Ti√™u Theo Lo·∫°i</h2>
        <div class="chart-container">
          <canvas id="barChart"></canvas>
        </div>
      </div>

      <!-- Bi·ªÉu ƒë·ªì ƒë∆∞·ªùng theo th·ªùi gian -->
      <div class="bg-white p-6 rounded-lg shadow-md lg:col-span-2">
        <h2 class="text-xl font-semibold mb-4">Xu H∆∞·ªõng Chi Ti√™u Theo Th·ªùi Gian</h2>
        <div class="chart-container">
          <canvas id="lineChart"></canvas>
        </div>
      </div>
    </div>

    <!-- B·∫£ng th·ªëng k√™ chi ti·∫øt -->
    <div class="bg-white p-6 rounded-lg shadow-md mt-6">
      <h2 class="text-xl font-semibold mb-4">Th·ªëng K√™ Chi Ti·∫øt Theo Lo·∫°i</h2>
      <div class="overflow-x-auto">
        <table class="w-full border-collapse">
          <thead>
            <tr class="bg-gray-100">
              <th class="border p-3 text-left">Lo·∫°i Chi Ti√™u</th>
              <th class="border p-3 text-right">T·ªïng Ti·ªÅn (k VND)</th>
              <th class="border p-3 text-right">S·ªë Giao D·ªãch</th>
              <th class="border p-3 text-right">Trung B√¨nh (k VND)</th>
              <th class="border p-3 text-right">% T·ªïng</th>
            </tr>
          </thead>
          <tbody id="detailTable"></tbody>
        </table>
      </div>
    </div>
  </div>

  <script>
    let expenseData = [];
    
    // T·∫£i d·ªØ li·ªáu t·ª´ localStorage
    function loadData() {
      const data = localStorage.getItem('expenseData');
      if (data) {
        expenseData = JSON.parse(data);
        console.log('D·ªØ li·ªáu ƒë∆∞·ª£c t·∫£i:', expenseData);
        initializeCharts();
        updateStats();
      } else {
        alert('Kh√¥ng c√≥ d·ªØ li·ªáu chi ti√™u!');
        window.close();
      }
    }

    // C·∫≠p nh·∫≠t th·ªëng k√™ t·ªïng quan
    function updateStats() {
      const total = expenseData.reduce((sum, exp) => sum + parseFloat(exp.amount), 0);
      const totalTransactions = expenseData.length;
      
      // T√≠nh s·ªë ng√†y duy nh·∫•t
      const uniqueDays = new Set(expenseData.map(exp => exp.date)).size;
      const avgPerDay = uniqueDays > 0 ? total / uniqueDays : 0;
      
      // T√¨m lo·∫°i chi ti√™u nhi·ªÅu nh·∫•t
      const categoryTotals = {};
      expenseData.forEach(exp => {
        categoryTotals[exp.category] = (categoryTotals[exp.category] || 0) + parseFloat(exp.amount);
      });
      const topCategory = Object.keys(categoryTotals).reduce((a, b) => 
        categoryTotals[a] > categoryTotals[b] ? a : b, '');

      document.getElementById('totalAmount').textContent = total.toFixed(0) + 'k';
      document.getElementById('totalTransactions').textContent = totalTransactions;
      document.getElementById('avgPerDay').textContent = avgPerDay.toFixed(0) + 'k';
      document.getElementById('topCategory').textContent = topCategory;

      updateDetailTable(categoryTotals, total);
    }

    // C·∫≠p nh·∫≠t b·∫£ng chi ti·∫øt
    function updateDetailTable(categoryTotals, total) {
      const tableBody = document.getElementById('detailTable');
      tableBody.innerHTML = '';

      Object.keys(categoryTotals).forEach(category => {
        const amount = categoryTotals[category];
        const transactions = expenseData.filter(exp => exp.category === category).length;
        const avg = amount / transactions;
        const percentage = (amount / total * 100).toFixed(1);

        const row = `
          <tr class="hover:bg-gray-50">
            <td class="border p-3">${category}</td>
            <td class="border p-3 text-right font-semibold">${amount.toFixed(0)}</td>
            <td class="border p-3 text-right">${transactions}</td>
            <td class="border p-3 text-right">${avg.toFixed(0)}</td>
            <td class="border p-3 text-right">${percentage}%</td>
          </tr>
        `;
        tableBody.innerHTML += row;
      });
    }

    // Kh·ªüi t·∫°o c√°c bi·ªÉu ƒë·ªì
    function initializeCharts() {
      const categories = {
        'Chi ph√≠ b·∫Øt bu·ªôc': 0,
        'ƒÇn ngo√†i & ƒëi ch∆°i': 0,
        'Ph√°t tri·ªÉn b·∫£n th√¢n': 0,
        'Ph√°t tri·ªÉn t√¨nh c·∫£m': 0,
        'Th·ªÉ thao, th·ªÉ ch·∫•t': 0
      };

      expenseData.forEach(exp => {
        categories[exp.category] += parseFloat(exp.amount);
      });

      const labels = Object.keys(categories);
      const data = Object.values(categories);
      const colors = ['#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF'];

      // Bi·ªÉu ƒë·ªì tr√≤n
      new Chart(document.getElementById('pieChart'), {
        type: 'doughnut',
        data: {
          labels: labels,
          datasets: [{
            data: data,
            backgroundColor: colors,
            borderWidth: 2
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { position: 'bottom' }
          }
        }
      });

      // Bi·ªÉu ƒë·ªì c·ªôt
      new Chart(document.getElementById('barChart'), {
        type: 'bar',
        data: {
          labels: labels,
          datasets: [{
            label: 'Chi ti√™u (k VND)',
            data: data,
            backgroundColor: colors,
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            y: { beginAtZero: true }
          }
        }
      });

      // Bi·ªÉu ƒë·ªì ƒë∆∞·ªùng theo th·ªùi gian
      createTimelineChart();
    }

    // T·∫°o bi·ªÉu ƒë·ªì xu h∆∞·ªõng theo th·ªùi gian
    function createTimelineChart() {
      const dailyTotals = {};
      
      expenseData.forEach(exp => {
        if (!dailyTotals[exp.date]) {
          dailyTotals[exp.date] = 0;
        }
        dailyTotals[exp.date] += parseFloat(exp.amount);
      });

      const sortedDates = Object.keys(dailyTotals).sort((a, b) => {
        const [dayA, monthA] = a.split('/').map(Number);
        const [dayB, monthB] = b.split('/').map(Number);
        return (monthA - monthB) || (dayA - dayB);
      });

      const timelineData = sortedDates.map(date => dailyTotals[date]);

      new Chart(document.getElementById('lineChart'), {
        type: 'line',
        data: {
          labels: sortedDates,
          datasets: [{
            label: 'Chi ti√™u h√†ng ng√†y (k VND)',
            data: timelineData,
            borderColor: '#8B5CF6',
            backgroundColor: 'rgba(139, 92, 246, 0.1)',
            tension: 0.4,
            fill: true
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            y: { beginAtZero: true }
          },
          plugins: {
            legend: { display: true }
          }
        }
      });
    }

    // T·∫£i d·ªØ li·ªáu khi trang ƒë∆∞·ª£c load
    window.onload = loadData;
  </script>
</body>
</html>