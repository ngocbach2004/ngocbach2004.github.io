<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Qu·∫£n L√Ω Chi Ti√™u C√° Nh√¢n</title>
  <!-- Tailwind CSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Chart.js CDN -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- Firebase SDK (UMD version) -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
  <style>
    body {
      font-family: 'Arial', sans-serif;
    }
    .container {
      max-width: 800px;
      margin: 0 auto;
      padding: 20px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }
    th, td {
      border: 1px solid #ddd;
      padding: 8px;
      text-align: left;
    }
    th {
      background-color: #f2f2f2;
    }
    canvas {
      max-width: 400px;
      margin: 20px auto;
    }
    .no-data {
      text-align: center;
      color: #888;
      padding: 10px;
    }
  </style>
</head>
<body class="bg-gray-100">
  <div class="container mx-auto">
    <!-- Header -->
    <header class="bg-blue-600 text-white p-4 text-center rounded-lg">
      <h1 class="text-3xl font-bold">Qu·∫£n L√Ω Chi Ti√™u C√° Nh√¢n</h1>
      <p class="text-lg mt-2">Th·ªùi gian hi·ªán t·∫°i: <span id="currentTime"></span></p>
    </header>

    <!-- Form nh·∫≠p chi ti√™u -->
    <section class="mt-6 bg-white p-6 rounded-lg shadow-md">
      <h2 class="text-2xl font-semibold mb-4">Th√™m Chi Ti√™u M·ªõi</h2>
      <form id="expenseForm" class="grid grid-cols-1 gap-4">
        <div>
          <label class="block text-sm font-medium">Ng√†y (dd/mm):</label>
          <input type="text" id="date" class="mt-1 p-2 w-full border rounded" placeholder="VD: 01/05" required>
        </div>
        <div>
          <label class="block text-sm font-medium">M√¥ t·∫£:</label>
          <input type="text" id="description" class="mt-1 p-2 w-full border rounded" placeholder="VD: ƒÇn s√°ng" required>
        </div>
        <div>
          <label class="block text-sm font-medium">S·ªë ti·ªÅn (k VND):</label>
          <input type="number" id="amount" class="mt-1 p-2 w-full border rounded" placeholder="VD: 50" required>
        </div>
        <div>
          <label class="block text-sm font-medium">Lo·∫°i:</label>
          <select id="category" class="mt-1 p-2 w-full border rounded" required>
            <option value="Chi ph√≠ b·∫Øt bu·ªôc">Chi ph√≠ b·∫Øt bu·ªôc</option>
            <option value="ƒÇn ngo√†i & ƒëi ch∆°i">ƒÇn ngo√†i & ƒëi ch∆°i</option>
            <option value="Ph√°t tri·ªÉn b·∫£n th√¢n">Ph√°t tri·ªÉn b·∫£n th√¢n</option>
            <option value="Ph√°t tri·ªÉn t√¨nh c·∫£m">Ph√°t tri·ªÉn t√¨nh c·∫£m</option>
            <option value="Th·ªÉ thao, th·ªÉ ch·∫•t">Th·ªÉ thao, th·ªÉ ch·∫•t</option>
          </select>
        </div>
        <button type="submit" class="bg-blue-500 text-white p-2 rounded hover:bg-blue-600">Th√™m</button>
      </form>
    </section>

    <!-- L·ªçc theo th√°ng -->
    <section class="mt-6 bg-white p-6 rounded-lg shadow-md">
      <h2 class="text-2xl font-semibold mb-4">Xem Th·ªëng K√™ Theo Th√°ng</h2>
      <div class="flex gap-4 items-center">
        <div>
          <label class="block text-sm font-medium">Ch·ªçn th√°ng (MM/YYYY):</label>
          <select id="monthFilter" class="mt-1 p-2 w-full border rounded">
            <option value="">T·∫•t c·∫£</option>
            <option value="04/2025">04/2025</option>
            <option value="05/2025">05/2025</option>
          </select>
        </div>
        <button onclick="filterByMonth()" class="bg-green-500 text-white p-2 rounded hover:bg-green-600 mt-6">Xem th·ªëng k√™</button>
      </div>
    </section>

    <!-- Summary Section -->
    <section class="mt-6 bg-white p-6 rounded-lg shadow-md">
      <h2 class="text-2xl font-semibold mb-4">T·ªïng Quan Chi Ti√™u</h2>
      <p class="text-lg"><strong>T·ªïng chi ti√™u:</strong> <span id="totalExpense">0</span>k VND</p>
      <h3 class="text-xl font-medium mt-4">Ph√¢n lo·∫°i chi ti√™u:</h3>
      <ul class="list-disc pl-5" id="categorySummary">
        <li>Chi ph√≠ b·∫Øt bu·ªôc: <span id="cat1">0</span>k VND</li>
        <li>ƒÇn ngo√†i & ƒëi ch∆°i: <span id="cat2">0</span>k VND</li>
        <li>Ph√°t tri·ªÉn b·∫£n th√¢n: <span id="cat3">0</span>k VND</li>
        <li>Ph√°t tri·ªÉn t√¨nh c·∫£m: <span id="cat4">0</span>k VND</li>
        <li>Th·ªÉ thao, th·ªÉ ch·∫•t: <span id="cat5">0</span>k VND</li>
      </ul>
      <h3 class="text-xl font-medium mt-4">Chi ph√≠ theo nƒÉm:</h3>
      <ul class="list-disc pl-5">
        <li>Sinh nh·∫≠t b·ªë: 430k VND</li>
        <li>YouTube Premium: 390k VND</li>
      </ul>
      <!-- N√∫t xem chi ti·∫øt -->
      <div class="mt-6">
        <button onclick="viewDetailedStats()" class="bg-purple-600 text-white px-6 py-3 rounded-lg hover:bg-purple-700 font-semibold">
          üìä Xem Chi Ti·∫øt Th·ªëng K√™
        </button>
      </div>
    </section>

    <!-- Chart Section -->
    <section class="mt-6 bg-white p-6 rounded-lg shadow-md">
      <h2 class="text-2xl font-semibold mb-4">Bi·ªÉu ƒê·ªì Ph√¢n Lo·∫°i Chi Ti√™u</h2>
      <canvas id="expenseChart"></canvas>
    </section>

    <!-- Expense Table -->
    <section class="mt-6 bg-white p-6 rounded-lg shadow-md">
      <h2 class="text-2xl font-semibold mb-4" id="expenseTableTitle">Chi Ti√™u H√†ng Ng√†y</h2>
      <table>
        <thead>
          <tr>
            <th>Ng√†y</th>
            <th>M√¥ t·∫£</th>
            <th>S·ªë Ti·ªÅn (k VND)</th>
            <th>Lo·∫°i</th>
            <th>Thao t√°c</th>
          </tr>
        </thead>
        <tbody id="expenseTable"></tbody>
      </table>
    </section>
  </div>

  <!-- JavaScript -->
  <script>
    // Hi·ªÉn th·ªã th·ªùi gian th·ª±c
    function updateCurrentTime() {
      const now = new Date();
      const days = ['Ch·ªß Nh·∫≠t', 'Th·ª© Hai', 'Th·ª© Ba', 'Th·ª© T∆∞', 'Th·ª© NƒÉm', 'Th·ª© S√°u', 'Th·ª© B·∫£y'];
      const dayOfWeek = days[now.getDay()];
      const date = now.getDate().toString().padStart(2, '0');
      const month = (now.getMonth() + 1).toString().padStart(2, '0');
      const year = now.getFullYear();
      const hours = now.getHours();
      const minutes = now.getMinutes().toString().padStart(2, '0');
      const seconds = now.getSeconds().toString().padStart(2, '0');
      const ampm = hours >= 12 ? 'PM' : 'AM';
      const hours12 = hours % 12 || 12;
      const timeString = `${dayOfWeek}, ${date}/${month}/${year} ${hours12}:${minutes}:${seconds} ${ampm} +07`;
      document.getElementById('currentTime').textContent = timeString;
    }
    updateCurrentTime();
    setInterval(updateCurrentTime, 1000);

    // C·∫•u h√¨nh Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyDARmzgC7Tx8SGlj2Qv_HX7D0r8E0BXE",
      authDomain: "expense-tracker-932d2.firebaseapp.com",
      projectId: "expense-tracker-932d2",
      storageBucket: "expense-tracker-932d2.appspot.com",
      messagingSenderId: "435106477971",
      appId: "1:435106477971:web:d269d6412c3b88a2e15a66",
      measurementId: "G-J3JMD2YLRG"
    };

    // Kh·ªüi t·∫°o Firebase
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // Kh·ªüi t·∫°o bi·ªÉu ƒë·ªì
    const ctx = document.getElementById('expenseChart').getContext('2d');
    const expenseChart = new Chart(ctx, {
      type: 'pie',
      data: {
        labels: [
          'Chi ph√≠ b·∫Øt bu·ªôc',
          'ƒÇn ngo√†i & ƒëi ch∆°i',
          'Ph√°t tri·ªÉn b·∫£n th√¢n',
          'Ph√°t tri·ªÉn t√¨nh c·∫£m',
          'Th·ªÉ thao, th·ªÉ ch·∫•t'
        ],
        datasets: [{
          label: 'Chi Ti√™u',
          data: [0, 0, 0, 0, 0],
          backgroundColor: ['#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF'],
          borderColor: '#fff',
          borderWidth: 1
        }]
      },
      options: {
        responsive: true,
        plugins: {
          legend: { position: 'top' },
          title: { display: true, text: 'Ph√¢n Lo·∫°i Chi Ti√™u' }
        }
      }
    });

    // Bi·∫øn l∆∞u tr·ªØ t·∫•t c·∫£ chi ti√™u
    let allExpenses = [];

    // T·∫£i v√† hi·ªÉn th·ªã chi ti√™u
    function loadExpenses() {
      db.collection('expenses').onSnapshot(snapshot => {
        console.log("S·ªë l∆∞·ª£ng document trong Firestore: ", snapshot.size);
        allExpenses = [];
        snapshot.forEach(doc => {
          const exp = { id: doc.id, ...doc.data() };
          console.log("Document t·ª´ Firestore: ", exp);
          if (!exp.date || !exp.description || exp.amount === undefined || !exp.category) {
            console.warn("D·ªØ li·ªáu kh√¥ng h·ª£p l·ªá, b·ªè qua: ", exp);
            return;
          }
          allExpenses.push(exp);
        });
        // S·∫Øp x·∫øp theo date trong JavaScript
        allExpenses.sort((a, b) => {
          const [dayA, monthA] = a.date.split('/').map(Number);
          const [dayB, monthB] = b.date.split('/').map(Number);
          return (monthA - monthB) || (dayA - dayB);
        });
        console.log("D·ªØ li·ªáu sau khi x·ª≠ l√Ω: ", allExpenses);
        // Hi·ªÉn th·ªã t·∫•t c·∫£ d·ªØ li·ªáu ban ƒë·∫ßu
        updateTable(allExpenses);
        updateSummary(allExpenses);
        updateChartTitle("");
      }, error => {
        console.error("L·ªói khi t·∫£i chi ti√™u: ", error);
      });
    }

    // L·ªçc chi ti√™u theo th√°ng
    function filterByMonth() {
      const selectedMonth = document.getElementById('monthFilter').value;
      let filteredExpenses = allExpenses;

      if (selectedMonth) {
        filteredExpenses = allExpenses.filter(exp => {
          const [day, monthYear] = exp.date.split('/');
          return monthYear === selectedMonth;
        });
        updateChartTitle(selectedMonth);
        document.getElementById('expenseTableTitle').textContent = `Chi Ti√™u H√†ng Ng√†y - Th√°ng ${selectedMonth}`;
      } else {
        updateChartTitle("");
        document.getElementById('expenseTableTitle').textContent = "Chi Ti√™u H√†ng Ng√†y";
      }

      console.log("D·ªØ li·ªáu sau khi l·ªçc: ", filteredExpenses);
      updateTable(filteredExpenses);
      updateSummary(filteredExpenses);
    }

    // C·∫≠p nh·∫≠t ti√™u ƒë·ªÅ bi·ªÉu ƒë·ªì
    function updateChartTitle(month) {
      expenseChart.options.plugins.title.text = month ? `Ph√¢n Lo·∫°i Chi Ti√™u - Th√°ng ${month}` : 'Ph√¢n Lo·∫°i Chi Ti√™u';
      expenseChart.update();
    }

    // C·∫≠p nh·∫≠t b·∫£ng chi ti√™u
    function updateTable(expenses) {
      const tableBody = document.getElementById('expenseTable');
      tableBody.innerHTML = '';
      if (expenses.length === 0) {
        tableBody.innerHTML = '<tr><td colspan="5" class="no-data">Kh√¥ng c√≥ d·ªØ li·ªáu chi ti√™u</td></tr>';
        return;
      }
      expenses.forEach(exp => {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${exp.date}</td>
          <td>${exp.description}</td>
          <td>${exp.amount}</td>
          <td>${exp.category}</td>
          <td>
            <button onclick="editExpense('${exp.id}')" class="bg-yellow-500 text-white p-1 rounded">S·ª≠a</button>
            <button onclick="deleteExpense('${exp.id}')" class="bg-red-500 text-white p-1 rounded">X√≥a</button>
          </td>
        `;
        tableBody.appendChild(row);
      });
    }

    // C·∫≠p nh·∫≠t t·ªïng quan v√† bi·ªÉu ƒë·ªì
    function updateSummary(expenses) {
      const categories = {
        'Chi ph√≠ b·∫Øt bu·ªôc': 0,
        'ƒÇn ngo√†i & ƒëi ch∆°i': 0,
        'Ph√°t tri·ªÉn b·∫£n th√¢n': 0,
        'Ph√°t tri·ªÉn t√¨nh c·∫£m': 0,
        'Th·ªÉ thao, th·ªÉ ch·∫•t': 0
      };
      let total = 0;

      expenses.forEach(exp => {
        const amount = parseFloat(exp.amount);
        if (!isNaN(amount) && amount > 0) {
          categories[exp.category] += amount;
          total += amount;
        }
      });

      document.getElementById('totalExpense').textContent = total.toFixed(0);
      document.getElementById('cat1').textContent = categories['Chi ph√≠ b·∫Øt bu·ªôc'].toFixed(0);
      document.getElementById('cat2').textContent = categories['ƒÇn ngo√†i & ƒëi ch∆°i'].toFixed(0);
      document.getElementById('cat3').textContent = categories['Ph√°t tri·ªÉn b·∫£n th√¢n'].toFixed(0);
      document.getElementById('cat4').textContent = categories['Ph√°t tri·ªÉn t√¨nh c·∫£m'].toFixed(0);
      document.getElementById('cat5').textContent = categories['Th·ªÉ thao, th·ªÉ ch·∫•t'].toFixed(0);

      expenseChart.data.datasets[0].data = [
        categories['Chi ph√≠ b·∫Øt bu·ªôc'],
        categories['ƒÇn ngo√†i & ƒëi ch∆°i'],
        categories['Ph√°t tri·ªÉn b·∫£n th√¢n'],
        categories['Ph√°t tri·ªÉn t√¨nh c·∫£m'],
        categories['Th·ªÉ thao, th·ªÉ ch·∫•t']
      ];
      expenseChart.update();
    }

    // Th√™m chi ti√™u
    document.getElementById('expenseForm').addEventListener('submit', e => {
      e.preventDefault();
      const date = document.getElementById('date').value;
      const description = document.getElementById('description').value;
      const amount = parseFloat(document.getElementById('amount').value);
      const category = document.getElementById('category').value;

      if (isNaN(amount)) {
        console.error("S·ªë ti·ªÅn kh√¥ng h·ª£p l·ªá: ", amount);
        return;
      }

      db.collection('expenses').add({
        date,
        description,
        amount,
        category,
        timestamp: firebase.firestore.FieldValue.serverTimestamp()
      }).then(() => {
        document.getElementById('expenseForm').reset();
        console.log("Th√™m chi ti√™u th√†nh c√¥ng: ", { date, description, amount, category });
      }).catch(error => {
        console.error("L·ªói khi th√™m chi ti√™u: ", error);
      });
    });

    // S·ª≠a chi ti√™u
    window.editExpense = function(id) {
      db.collection('expenses').doc(id).get().then(doc => {
        const exp = doc.data();
        document.getElementById('date').value = exp.date;
        document.getElementById('description').value = exp.description;
        document.getElementById('amount').value = exp.amount;
        document.getElementById('category').value = exp.category;

        document.getElementById('expenseForm').onsubmit = e => {
          e.preventDefault();
          const updatedAmount = parseFloat(document.getElementById('amount').value);
          if (isNaN(updatedAmount)) {
            console.error("S·ªë ti·ªÅn kh√¥ng h·ª£p l·ªá khi s·ª≠a: ", updatedAmount);
            return;
          }
          db.collection('expenses').doc(id).update({
            date: document.getElementById('date').value,
            description: document.getElementById('description').value,
            amount: updatedAmount,
            category: document.getElementById('category').value,
            timestamp: firebase.firestore.FieldValue.serverTimestamp()
          }).then(() => {
            document.getElementById('expenseForm').reset();
            document.getElementById('expenseForm').onsubmit = addExpense;
            console.log("S·ª≠a chi ti√™u th√†nh c√¥ng: ", id);
          }).catch(error => {
            console.error("L·ªói khi s·ª≠a chi ti√™u: ", error);
          });
        };
      }).catch(error => {
        console.error("L·ªói khi l·∫•y chi ti√™u ƒë·ªÉ s·ª≠a: ", error);
      });
    };

    // X√≥a chi ti√™u
    window.deleteExpense = function(id) {
      if (confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a m·ª•c n√†y?')) {
        db.collection('expenses').doc(id).delete().then(() => {
          console.log("X√≥a chi ti√™u th√†nh c√¥ng: ", id);
        }).catch(error => {
          console.error("L·ªói khi x√≥a chi ti√™u: ", error);
        });
      }
    };

    // G·ªçi h√†m t·∫£i chi ti√™u khi trang ƒë∆∞·ª£c t·∫£i
    loadExpenses();

    // Function chuy·ªÉn sang trang th·ªëng k√™ chi ti·∫øt
    function viewDetailedStats() {
      // L∆∞u d·ªØ li·ªáu v√†o localStorage ƒë·ªÉ truy·ªÅn sang trang kh√°c
      localStorage.setItem('expenseData', JSON.stringify(allExpenses));
      // Chuy·ªÉn sang trang th·ªëng k√™
      window.open('stats.html', '_blank');
    }

    // Kh√¥i ph·ª•c h√†m th√™m chi ti√™u m·∫∑c ƒë·ªãnh
    const addExpense = e => {
      e.preventDefault();
      const date = document.getElementById('date').value;
      const description = document.getElementById('description').value;
      const amount = parseFloat(document.getElementById('amount').value);
      const category = document.getElementById('category').value;

      if (isNaN(amount)) {
        console.error("S·ªë ti·ªÅn kh√¥ng h·ª£p l·ªá: ", amount);
        return;
      }

      db.collection('expenses').add({
        date,
        description,
        amount,
        category,
        timestamp: firebase.firestore.FieldValue.serverTimestamp()
      }).then(() => {
        document.getElementById('expenseForm').reset();
        console.log("Th√™m chi ti√™u th√†nh c√¥ng: ", { date, description, amount, category });
      }).catch(error => {
        console.error("L·ªói khi th√™m chi ti√™u: ", error);
      });
    };
    document.getElementById('expenseForm').onsubmit = addExpense;
  </script>
</body>
</html>
